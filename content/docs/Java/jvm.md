---
title: JVM
linktitle: jvm
type: book
date: "2021-01-02T00:00:00+01:00"

# Prev/next pager order (if `docs_section_pager` enabled in `params.toml`)
weight: 4
---

## JVM 内存模型

Java虚拟机在执行Java程序的过程中会把它所管理的内存划分为若干个不同的数据区域。这些区域有各自的用途，以及创建和销毁的时间，有的区域随着虚拟机进程的启动而一直存在，有些区域则是依赖用户线程的启动和结束而建立和销毁。根据《Java虚拟机规范》的规定，Java虚拟机所管理的内存将会包括以下几个运行时数据区域。

![](https://cdn.jsdelivr.net/gh/gyl-coder/bookImgs/java/jvm/7.png)

### 程序计数器

程序计数器是一块较小的内存空间，可以把它看做是当前线程所执行的字节码的行号指示器。在Java虚拟机的概念模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，它是程序控制流的指示器，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。

Java 虚拟机的多线程是通过线程轮流切换、分配处理器执行时间的方式来实现的，在任何一个时刻，一个处理器都只会执行一条线程中的指令。因此，为了线程切换后能恢复到正确的执行位置，每条线程都需要有一个独立的程序计数器，各条线程之间计数器互不影响，独立存储，我们称这类内存区域为“线程私有”的内存。

### 虚拟机栈

Java 虚拟机栈（Java Virtual Machine Stack），和程序计数器相同它也是线程独享的，生命周期和线程相同。用来描述 Java 方法的执行的内存模型，在每个方法被执行时会创建一个栈帧，用来存储局部变量表、操作栈、动态链接、方法出口等信息。当调用方法时执行入栈，方法返回时执行出栈。

局部变量表存放了编译期可知的各种基本数据类型（boolean、byte、short、int、long、float、double、char）、对象引用（指向对象起始地址的指针）和 returnAddress 类型（指向一条字节码指令的地址）。

局部变量表所需要的的内存在编译期间完成分配。运行期间不会改变局部变量表的大小。

### 本地方法栈

本地方法栈（Native Method Stacks）与虚拟机栈类似，也是线程独享的，并且作用也和虚拟机栈类似。只不过虚拟机栈是为虚拟机中执行的 Java 方法服务的，而本地方法栈则是为虚拟机使用到的本地（Native）方法服务。

#### 堆

堆（Java Heap）也叫Java堆或者GC堆，他是线程共享的一块内存区域，也是JVM中占用内存最大的一块区域，Java的大部分对象都存储在这里。
堆大小的值可通过 -Xms 和 -Xmx 来设置（设置最小值和最大值），当堆超过最大值时就会抛出 OOM（OutOfMemoryError）异常。

### 方法区

方法区（Method Area） 也被称为非堆区，用于和“Java 堆”的概念进行区分，它也是线程共享的内存区域，用于存储已经被 JVM 加载的类型信息、常量、静态变量、代码缓存等数据。

### 运行时常量池

运行时常量池是方法区的一部分。Class 文件中除了有类的版本、字段、方法、接口等描述信息外，还有常量池信息（用于存放编译期生成的各种字面量和符号引用）
既然运行时常量池时方法区的一部分，自然受到方法区内存的限制，当常量池无法再申请到内存时会抛出 OutOfMemoryError 异常。

JDK1.7及之后版本的 JVM 已经将运行时常量池从方法区中移了出来，在 Java 堆（Heap）中开辟了一块区域存放运行时常量池。

### 直接内存

直接内存并不是虚拟机运行时数据区的一部分，也不是虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用。而且也可能导致 OutOfMemoryError 异常出现。

JDK1.4中新加入的 NIO(New Input/Output) 类，引入了一种基于通道（Channel） 与缓存区（Buffer） 的 I/O 方式，它可以直接使用Native函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样就能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆之间来回复制数据。
本机直接内存的分配不会收到 Java 堆的限制，但是，既然是内存就会受到本机总内存大小以及处理器寻址空间的限制。

## 虚拟机类加载机制

### 类加载机制

[https://gyl-coder.top/java/jvm/jvm-class-loader/](https://gyl-coder.top/java/jvm/jvm-class-loader/)

### 类加载器

[https://gyl-coder.top/java/jvm/jvm-class-loader2/](https://gyl-coder.top/java/jvm/jvm-class-loader2/)
